<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm tra ƒëi·ªÉm qua m√¥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            display: inline-block;
            transition: transform 0.3s;
        }

        .file-label:hover {
            transform: scale(1.05);
        }

        .file-name {
            margin-top: 15px;
            font-size: 1em;
            color: #667eea;
            font-weight: bold;
        }

        .weights-info {
            background: #e8f4f8;
            border-left: 5px solid #17a2b8;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .weights-info h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .weights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .weight-item {
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .results-section {
            margin-top: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .pass {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .fail {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .badge-pass {
            background: #28a745;
            color: white;
        }

        .badge-fail {
            background: #dc3545;
            color: white;
        }

        .export-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .hidden {
            display: none;
        }

        .config-section {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .config-header h3 {
            color: #856404;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }

        .weight-editor {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .weight-row {
            display: grid;
            grid-template-columns: 1fr 1fr 100px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .weight-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .weight-row button {
            padding: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .weight-row button:hover {
            background: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Ki·ªÉm tra ƒëi·ªÉm qua m√¥n</h1>
            <p>Upload file Excel ƒë·ªÉ t√≠nh ƒëi·ªÉm v√† ki·ªÉm tra k·∫øt qu·∫£ h·ªçc t·∫≠p</p>
            <p style="font-size: 0.9em; margin-top: 5px;">T·ªïng tr·ªçng s·ªë: 60% | Qua m√¥n: ‚â•3/6 ƒëi·ªÉm (50%)</p>
        </div>

        <div class="content">
            <div class="config-section">
                <div class="config-header">
                    <h3>‚öôÔ∏è C·∫•u h√¨nh tr·ªçng s·ªë</h3>
                    <div class="btn-group">
                        <select id="profileSelect" onchange="loadProfile()">
                            <option value="default">M·∫∑c ƒë·ªãnh (60%)</option>
                        </select>
                        <button class="btn btn-primary" onclick="openWeightEditor()">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
                        <button class="btn btn-success" onclick="createNewProfile()">‚ûï T·∫°o m·ªõi</button>
                        <button class="btn" style="background: #6f42c1; color: white;" onclick="duplicateCurrentProfile()">üìë Nh√¢n b·∫£n</button>
                        <button class="btn btn-warning" onclick="exportConfig()">üì§ Xu·∫•t</button>
                        <label for="importConfig" class="btn" style="background: #17a2b8; color: white; cursor: pointer;">üì• Nh·∫≠p</label>
                        <input type="file" id="importConfig" accept=".json" style="display: none;" onchange="importConfig(event)">
                    </div>
                </div>
                <div id="currentWeightSummary" style="font-size: 0.9em; color: #856404;">
                    ƒêang s·ª≠ d·ª•ng: <strong>M·∫∑c ƒë·ªãnh</strong> - T·ªïng: 60%
                </div>
            </div>

            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(event)">
                    <label for="fileInput" class="file-label">
                        üìÇ Ch·ªçn file Excel ƒëi·ªÉm
                    </label>
                </div>
                <div class="file-name" id="fileName"></div>
            </div>

            <div class="config-section" style="background: #e7f3ff; border-left-color: #0066cc;">
                <div class="config-header">
                    <h3 style="color: #004085;">üë• Qu·∫£n l√Ω l·ªõp h·ªçc</h3>
                    <div class="btn-group">
                        <select id="classSelect" onchange="loadClass()" style="min-width: 200px;">
                            <option value="">-- Ch·ªçn l·ªõp --</option>
                        </select>
                        <button class="btn btn-success" onclick="createNewClass()">‚ûï T·∫°o l·ªõp m·ªõi</button>
                        <button class="btn btn-primary" onclick="editClass()">‚úèÔ∏è S·ª≠a</button>
                        <button class="btn" style="background: #dc3545; color: white;" onclick="deleteClass()">üóëÔ∏è X√≥a</button>
                    </div>
                </div>
                <div id="classInfo" style="font-size: 0.9em; color: #004085; display: none;">
                    <strong>Th√¥ng tin:</strong> <span id="classDetails"></span>
                </div>
            </div>

            <div class="config-section" style="background: #d1ecf1; border-left-color: #17a2b8;">
                <h3 style="color: #0c5460; margin-bottom: 15px;">üìã T·∫°o b·∫£ng ƒëi·ªÉm Template</h3>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="color: #0c5460; font-weight: bold; display: block; margin-bottom: 5px;">Ch·ªçn ngu·ªìn danh s√°ch:</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="templateSource" value="class" checked onchange="updateTemplateSource()">
                                <span>T·ª´ l·ªõp ƒë√£ l∆∞u</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="templateSource" value="upload" onchange="updateTemplateSource()">
                                <span>Upload file m·ªõi</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="classSourceSection">
                    <p style="color: #0c5460; margin-bottom: 10px;">S·ª≠ d·ª•ng danh s√°ch sinh vi√™n t·ª´ l·ªõp ƒë√£ ch·ªçn ·ªü tr√™n</p>
                </div>

                <div id="uploadSourceSection" style="display: none;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div style="flex: 1;">
                            <input type="file" id="classListInput" accept=".xlsx, .xls" style="display: none;" onchange="handleClassListUpload(event)">
                            <label for="classListInput" class="btn btn-primary" style="cursor: pointer; display: inline-block;">
                                üìÅ Ch·ªçn danh s√°ch l·ªõp
                            </label>
                            <span id="classListFileName" style="margin-left: 10px; color: #0c5460;"></span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #0c5460;">
                        <strong>L∆∞u √Ω:</strong> File danh s√°ch l·ªõp c·∫ßn c√≥ √≠t nh·∫•t 2 c·ªôt: MSSV v√† H·ªç v√† t√™n
                    </div>
                </div>

                <button class="btn" style="background: #17a2b8; color: white; margin-top: 15px;" onclick="generateTemplate()" id="generateTemplateBtn" disabled>
                    üìù T·∫°o Template Excel
                </button>
            </div>

            <div class="weights-info">
                <h3>üìä Th√¥ng tin tr·ªçng s·ªë ƒëi·ªÉm (T·ªïng: 60%)</h3>
                <div class="weights-grid">
                    <div class="weight-item"><strong>Lab 1:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Quiz 3:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 4:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 5:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 6:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 7:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 8:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Assignment Gƒê1:</strong> 10%</div>
                    <div class="weight-item"><strong>Assignment Gƒê2:</strong> 10%</div>
                    <div class="weight-item"><strong>Lab 2:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 3:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 4:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 5:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 6:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 7:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Lab 8:</strong> 3.5%</div>
                    <div class="weight-item"><strong>Quiz 1:</strong> 1.5%</div>
                    <div class="weight-item"><strong>Quiz 2:</strong> 1.5%</div>
                </div>
            </div>

            <div id="resultsSection" class="results-section hidden">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalStudents">0</h3>
                        <p>T·ªïng sinh vi√™n</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="passedStudents">0</h3>
                        <p>ƒê√£ qua m√¥n (‚â•3/6)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="failedStudents">0</h3>
                        <p>Ch∆∞a qua m√¥n (<3/6)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="passRate">0%</h3>
                        <p>T·ª∑ l·ªá qua m√¥n</p>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>MSSV</th>
                                <th>H·ªç v√† t√™n</th>
                                <th>ƒêi·ªÉm t·ªïng</th>
                                <th>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>

                <button class="export-btn" onclick="exportResults()">üì• Xu·∫•t k·∫øt qu·∫£ Excel</button>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a l·ªõp h·ªçc -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Ch·ªânh s·ª≠a l·ªõp h·ªçc</h2>
                <button class="close-btn" onclick="closeClassEditor()">&times;</button>
            </div>
            <div>
                <label><strong>T√™n l·ªõp:</strong></label>
                <input type="text" id="className" placeholder="VD: SE1801" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">

                <label><strong>M√¥ t·∫£:</strong></label>
                <input type="text" id="classDescription" placeholder="VD: L·∫≠p tr√¨nh Java - Kh√≥a 18" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">

                <div style="margin: 15px 0;">
                    <strong>Danh s√°ch sinh vi√™n:</strong>
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <input type="file" id="classStudentListInput" accept=".xlsx, .xls" style="display: none;" onchange="handleClassStudentUpload(event)">
                        <label for="classStudentListInput" class="btn btn-primary" style="cursor: pointer;">
                            üìÅ Upload danh s√°ch
                        </label>
                        <button class="btn btn-success" onclick="addStudentRow()">‚ûï Th√™m SV th·ªß c√¥ng</button>
                    </div>
                </div>

                <div id="studentEditor" class="weight-editor" style="max-height: 300px;">
                    <!-- Student rows will be added here -->
                </div>

                <div style="margin-top: 15px; font-weight: bold;">
                    T·ªïng s·ªë sinh vi√™n: <span id="totalStudents">0</span>
                </div>

                <div class="btn-group" style="margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="saveClass()">üíæ L∆∞u</button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="closeClassEditor()">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a tr·ªçng s·ªë -->
    <div id="weightModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Ch·ªânh s·ª≠a tr·ªçng s·ªë</h2>
                <button class="close-btn" onclick="closeWeightEditor()">&times;</button>
            </div>
            <div>
                <label><strong>T√™n profile:</strong></label>
                <input type="text" id="profileName" placeholder="Nh·∫≠p t√™n profile" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">

                <div style="margin: 10px 0;">
                    <label><strong>Sao ch√©p t·ª´ profile:</strong></label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <select id="copyFromProfile" style="flex: 1;">
                            <option value="">-- Ch·ªçn profile ƒë·ªÉ sao ch√©p --</option>
                        </select>
                        <button class="btn btn-primary" onclick="copyFromProfile()" style="padding: 8px 15px;">üìã Sao ch√©p</button>
                    </div>
                </div>

                <label><strong>Ng∆∞·ª°ng qua m√¥n (ƒëi·ªÉm):</strong></label>
                <input type="number" id="passThreshold" placeholder="3" step="0.1" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">

                <div style="margin: 15px 0;">
                    <strong>Danh s√°ch tr·ªçng s·ªë:</strong>
                    <button class="btn btn-success" onclick="addWeightRow()" style="margin-left: 10px; padding: 5px 15px;">‚ûï Th√™m</button>
                </div>

                <div id="weightEditor" class="weight-editor"></div>

                <div style="margin-top: 15px; font-weight: bold;">
                    T·ªïng tr·ªçng s·ªë: <span id="totalWeight">0</span>%
                </div>

                <div class="btn-group" style="margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="saveWeightProfile()">üíæ L∆∞u</button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="closeWeightEditor()">H·ªßy</button>
                    <button class="btn" style="background: #dc3545; color: white;" onclick="deleteProfile()">üóëÔ∏è X√≥a profile</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Qu·∫£n l√Ω profiles tr·ªçng s·ªë
        let profiles = {};
        let currentProfile = 'default';
        let weights = {};
        let passThreshold = 3;

        let processedData = [];
        let matchedColumns = {}; // L∆∞u c√°c c·ªôt ƒë√£ kh·ªõp ƒë·ªÉ hi·ªÉn th·ªã
        let classListData = []; // L∆∞u danh s√°ch l·ªõp ƒë·ªÉ t·∫°o template

        // Qu·∫£n l√Ω l·ªõp h·ªçc
        let classes = {};
        let currentClass = '';

        // Kh·ªüi t·∫°o profiles m·∫∑c ƒë·ªãnh
        function initDefaultProfiles() {
            const defaultProfile = {
                name: 'M·∫∑c ƒë·ªãnh (60%)',
                passThreshold: 3,
                weights: {
                    'Lab 1': 3.5,
                    'Lab 2': 3.5,
                    'Lab 3': 3.5,
                    'Lab 4': 3.5,
                    'Lab 5': 3.5,
                    'Lab 6': 3.5,
                    'Lab 7': 3.5,
                    'Lab 8': 3.5,
                    'Quiz 1': 1.5,
                    'Quiz 2': 1.5,
                    'Quiz 3': 1.5,
                    'Quiz 4': 1.5,
                    'Quiz 5': 1.5,
                    'Quiz 6': 1.5,
                    'Quiz 7': 1.5,
                    'Quiz 8': 1.5,
                    'GD 1': 10,
                    'GD 2': 10
                }
            };

            // Load t·ª´ localStorage ho·∫∑c d√πng m·∫∑c ƒë·ªãnh
            const saved = localStorage.getItem('gradeProfiles');
            if (saved) {
                profiles = JSON.parse(saved);
            } else {
                profiles = { default: defaultProfile };
                saveProfiles();
            }

            // Load profile hi·ªán t·∫°i
            const savedCurrent = localStorage.getItem('currentProfile');
            if (savedCurrent && profiles[savedCurrent]) {
                currentProfile = savedCurrent;
            }

            loadProfile();
            updateProfileSelect();
        }

        function saveProfiles() {
            localStorage.setItem('gradeProfiles', JSON.stringify(profiles));
        }

        function loadProfile() {
            const select = document.getElementById('profileSelect');
            if (select && select.value) {
                currentProfile = select.value;
            }

            const profile = profiles[currentProfile];
            if (profile) {
                weights = { ...profile.weights };
                passThreshold = profile.passThreshold || 3;
                localStorage.setItem('currentProfile', currentProfile);
                updateWeightSummary();
            }
        }

        function updateProfileSelect() {
            const select = document.getElementById('profileSelect');
            select.innerHTML = '';
            for (const [key, profile] of Object.entries(profiles)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = profile.name;
                if (key === currentProfile) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        function updateWeightSummary() {
            const total = Object.values(weights).reduce((sum, w) => sum + w, 0);
            const profile = profiles[currentProfile];
            document.getElementById('currentWeightSummary').innerHTML =
                `ƒêang s·ª≠ d·ª•ng: <strong>${profile.name}</strong> - T·ªïng: ${total.toFixed(1)}% - Qua m√¥n: ‚â•${passThreshold} ƒëi·ªÉm`;
        }

        // Ch·ªânh s·ª≠a tr·ªçng s·ªë
        function openWeightEditor() {
            const profile = profiles[currentProfile];
            document.getElementById('profileName').value = profile.name;
            document.getElementById('passThreshold').value = profile.passThreshold || 3;

            // Populate dropdown sao ch√©p profile
            populateCopyProfileDropdown();

            renderWeightEditor();
            document.getElementById('weightModal').classList.add('show');
        }

        function populateCopyProfileDropdown() {
            const select = document.getElementById('copyFromProfile');
            select.innerHTML = '<option value="">-- Ch·ªçn profile ƒë·ªÉ sao ch√©p --</option>';

            for (const [key, profile] of Object.entries(profiles)) {
                if (key !== currentProfile) { // Kh√¥ng hi·ªÉn th·ªã profile hi·ªán t·∫°i
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = profile.name;
                    select.appendChild(option);
                }
            }
        }

        function copyFromProfile() {
            const select = document.getElementById('copyFromProfile');
            const sourceProfileId = select.value;

            if (!sourceProfileId) {
                alert('Vui l√≤ng ch·ªçn profile ƒë·ªÉ sao ch√©p!');
                return;
            }

            const sourceProfile = profiles[sourceProfileId];
            if (!sourceProfile) {
                alert('Kh√¥ng t√¨m th·∫•y profile!');
                return;
            }

            // Copy ng∆∞·ª°ng qua m√¥n
            document.getElementById('passThreshold').value = sourceProfile.passThreshold || 3;

            // Copy weights
            const editor = document.getElementById('weightEditor');
            editor.innerHTML = '';

            for (const [key, value] of Object.entries(sourceProfile.weights)) {
                addWeightRowWithData(key, value);
            }

            calculateTotalWeight();

            // Reset dropdown
            select.value = '';

            alert(`ƒê√£ sao ch√©p c·∫•u h√¨nh t·ª´ "${sourceProfile.name}"!\nB·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a th√™m tr∆∞·ªõc khi l∆∞u.`);
        }

        function closeWeightEditor() {
            document.getElementById('weightModal').classList.remove('show');
        }

        function renderWeightEditor() {
            const editor = document.getElementById('weightEditor');
            editor.innerHTML = '';

            const profile = profiles[currentProfile];
            for (const [key, value] of Object.entries(profile.weights)) {
                addWeightRowWithData(key, value);
            }
            calculateTotalWeight();
        }

        function addWeightRow() {
            addWeightRowWithData('', 0);
        }

        function addWeightRowWithData(name, weight) {
            const editor = document.getElementById('weightEditor');
            const row = document.createElement('div');
            row.className = 'weight-row';
            row.innerHTML = `
                <input type="text" placeholder="T√™n c·ªôt (VD: Lab 1)" value="${name}" class="weight-name">
                <input type="number" placeholder="Tr·ªçng s·ªë (%)" value="${weight}" step="0.1" class="weight-value" oninput="calculateTotalWeight()">
                <button onclick="removeWeightRow(this)">X√≥a</button>
            `;
            editor.appendChild(row);
            calculateTotalWeight();
        }

        function removeWeightRow(btn) {
            btn.parentElement.remove();
            calculateTotalWeight();
        }

        function calculateTotalWeight() {
            const rows = document.querySelectorAll('.weight-row');
            let total = 0;
            rows.forEach(row => {
                const value = parseFloat(row.querySelector('.weight-value').value) || 0;
                total += value;
            });
            document.getElementById('totalWeight').textContent = total.toFixed(1);
        }

        function saveWeightProfile() {
            const name = document.getElementById('profileName').value.trim();
            const threshold = parseFloat(document.getElementById('passThreshold').value) || 3;

            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n profile!');
                return;
            }

            const rows = document.querySelectorAll('.weight-row');
            const newWeights = {};
            rows.forEach(row => {
                const key = row.querySelector('.weight-name').value.trim();
                const value = parseFloat(row.querySelector('.weight-value').value) || 0;
                if (key) {
                    newWeights[key] = value;
                }
            });

            profiles[currentProfile] = {
                name: name,
                passThreshold: threshold,
                weights: newWeights
            };

            saveProfiles();
            loadProfile();
            updateProfileSelect();
            closeWeightEditor();
            alert('ƒê√£ l∆∞u profile th√†nh c√¥ng!');
        }

        function createNewProfile() {
            const name = prompt('Nh·∫≠p t√™n profile m·ªõi:');
            if (!name) return;

            const id = 'profile_' + Date.now();
            profiles[id] = {
                name: name,
                passThreshold: 3,
                weights: {}
            };

            currentProfile = id;
            saveProfiles();
            updateProfileSelect();
            openWeightEditor();
        }

        function duplicateCurrentProfile() {
            const sourceProfile = profiles[currentProfile];
            const newName = prompt(`Nh·∫≠p t√™n cho b·∫£n sao c·ªßa "${sourceProfile.name}":`, `${sourceProfile.name} (Copy)`);

            if (!newName) return;

            const id = 'profile_' + Date.now();
            profiles[id] = {
                name: newName,
                passThreshold: sourceProfile.passThreshold,
                weights: { ...sourceProfile.weights } // Deep copy weights
            };

            currentProfile = id;
            saveProfiles();
            updateProfileSelect();
            loadProfile();

            alert(`ƒê√£ t·∫°o b·∫£n sao "${newName}"!\nB·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n√≥ b·∫±ng n√∫t "‚úèÔ∏è Ch·ªânh s·ª≠a".`);
        }

        function deleteProfile() {
            if (currentProfile === 'default') {
                alert('Kh√¥ng th·ªÉ x√≥a profile m·∫∑c ƒë·ªãnh!');
                return;
            }

            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a profile n√†y?')) {
                delete profiles[currentProfile];
                currentProfile = 'default';
                saveProfiles();
                updateProfileSelect();
                loadProfile();
                closeWeightEditor();
            }
        }

        function exportConfig() {
            const data = JSON.stringify(profiles, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grade_config_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('Import c·∫•u h√¨nh s·∫Ω ghi ƒë√® t·∫•t c·∫£ profiles hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                        profiles = imported;
                        saveProfiles();
                        currentProfile = 'default';
                        updateProfileSelect();
                        loadProfile();
                        alert('Import th√†nh c√¥ng!');
                    }
                } catch (error) {
                    alert('L·ªói: File kh√¥ng h·ª£p l·ªá!');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // X·ª≠ l√Ω upload danh s√°ch l·ªõp
        function handleClassListUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('classListFileName').textContent = `üìÑ ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                parseClassList(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function parseClassList(data) {
            if (data.length < 2) {
                alert('File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!');
                classListData = [];
                document.getElementById('generateTemplateBtn').disabled = true;
                return;
            }

            const headers = data[0];

            // T√¨m index c·ªßa c√°c c·ªôt
            const mssvIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('mssv') ||
                       normalized.includes('masinhvien') ||
                       normalized.includes('masv') ||
                       normalized === 'masinhvien' ||
                       normalized === 'ma';
            });

            const nameIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('ten') ||
                       normalized.includes('hova') ||
                       normalized.includes('hovaten') ||
                       normalized.includes('ho') ||
                       normalized === 'ten' ||
                       normalized === 'hovaten';
            });

            if (mssvIndex === -1 || nameIndex === -1) {
                const headerList = headers.filter(h => h).map((h, i) => `${i}: "${h}"`).join('\n');
                alert(`Kh√¥ng t√¨m th·∫•y c·ªôt MSSV ho·∫∑c H·ªç t√™n!\n\nC√°c c·ªôt t√¨m th·∫•y:\n${headerList}\n\nVui l√≤ng ƒë·∫£m b·∫£o file c√≥:\n- C·ªôt ch·ª©a "MSSV"\n- C·ªôt ch·ª©a "H·ªç v√† t√™n"`);
                classListData = [];
                document.getElementById('generateTemplateBtn').disabled = true;
                return;
            }

            // Parse danh s√°ch sinh vi√™n
            classListData = [];
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const mssv = row[mssvIndex] || '';
                const name = row[nameIndex] || '';

                if (mssv) {
                    classListData.push({ mssv, name });
                }
            }

            if (classListData.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y sinh vi√™n n√†o trong file!');
                document.getElementById('generateTemplateBtn').disabled = true;
                return;
            }

            document.getElementById('generateTemplateBtn').disabled = false;
            alert(`ƒê√£ t·∫£i danh s√°ch ${classListData.length} sinh vi√™n!\nClick "T·∫°o Template Excel" ƒë·ªÉ t·∫°o file m·∫´u.`);
        }

        function generateTemplate() {
            const source = document.querySelector('input[name="templateSource"]:checked').value;

            // X√°c ƒë·ªãnh data source
            let students = [];
            if (source === 'class') {
                if (!currentClass || !classes[currentClass]) {
                    alert('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!');
                    return;
                }
                students = classes[currentClass].students || [];
            } else {
                students = classListData;
            }

            if (students.length === 0) {
                alert('Danh s√°ch sinh vi√™n tr·ªëng!');
                return;
            }

            const profile = profiles[currentProfile];
            if (!profile || Object.keys(profile.weights).length === 0) {
                alert('Profile hi·ªán t·∫°i kh√¥ng c√≥ c·ªôt ƒëi·ªÉm n√†o!\nVui l√≤ng ch·ªânh s·ª≠a profile v√† th√™m c√°c c·ªôt ƒëi·ªÉm.');
                return;
            }

            // T·∫°o header row
            const headers = ['M√£ sinh vi√™n', 'H·ªç v√† t√™n'];
            const weightColumns = Object.keys(profile.weights).sort((a, b) => {
                // S·∫Øp x·∫øp: Lab tr∆∞·ªõc, Quiz sau, GD cu·ªëi
                const getOrder = (key) => {
                    if (key.includes('Lab')) return 1;
                    if (key.includes('Quiz')) return 2;
                    if (key.includes('GD')) return 3;
                    return 4;
                };
                const orderDiff = getOrder(a) - getOrder(b);
                if (orderDiff !== 0) return orderDiff;
                const numA = parseInt(a.match(/\d+/)?.[0] || 0);
                const numB = parseInt(b.match(/\d+/)?.[0] || 0);
                return numA - numB;
            });

            // Th√™m t√™n c·ªôt v√† tr·ªçng s·ªë v√†o header
            weightColumns.forEach(col => {
                const weight = profile.weights[col];
                headers.push(`${col} (${weight}%)`);
            });

            // T·∫°o data rows
            const rows = [headers];
            students.forEach(student => {
                const row = [student.mssv, student.name];
                // Th√™m c√°c √¥ tr·ªëng cho ƒëi·ªÉm
                weightColumns.forEach(() => row.push(''));
                rows.push(row);
            });

            // T·∫°o worksheet
            const ws = XLSX.utils.aoa_to_sheet(rows);

            // Style cho header (bold, background color)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = {
                    font: { bold: true },
                    fill: { fgColor: { rgb: "FFFF00" } }
                };
            }

            // Set column widths
            const colWidths = [
                { wch: 15 }, // MSSV
                { wch: 25 }  // H·ªç v√† t√™n
            ];
            weightColumns.forEach(() => {
                colWidths.push({ wch: 12 }); // C√°c c·ªôt ƒëi·ªÉm
            });
            ws['!cols'] = colWidths;

            // T·∫°o workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'B·∫£ng ƒëi·ªÉm');

            // Th√™m sheet h∆∞·ªõng d·∫´n
            const instructionData = [
                ['H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG'],
                [''],
                ['1. Nh·∫≠p ƒëi·ªÉm cho sinh vi√™n v√†o c√°c c·ªôt t∆∞∆°ng ·ª©ng'],
                ['2. ƒêi·ªÉm ƒë∆∞·ª£c t√≠nh theo thang 100'],
                ['3. ƒê·ªÉ tr·ªëng ho·∫∑c ƒëi·ªÅn 0 n·∫øu sinh vi√™n kh√¥ng c√≥ ƒëi·ªÉm'],
                ['4. Sau khi nh·∫≠p xong, upload file n√†y v√†o tool ƒë·ªÉ t√≠nh t·ªïng ƒëi·ªÉm'],
                [''],
                ['Th√¥ng tin Profile:'],
                [`T√™n: ${profile.name}`],
                [`Ng∆∞·ª°ng qua m√¥n: ${profile.passThreshold} ƒëi·ªÉm`],
                [`T·ªïng tr·ªçng s·ªë: ${Object.values(profile.weights).reduce((s, w) => s + w, 0)}%`],
                [''],
                ['Danh s√°ch tr·ªçng s·ªë:']
            ];

            weightColumns.forEach(col => {
                instructionData.push([`${col}: ${profile.weights[col]}%`]);
            });

            const wsInstruction = XLSX.utils.aoa_to_sheet(instructionData);
            XLSX.utils.book_append_sheet(wb, wsInstruction, 'H∆∞·ªõng d·∫´n');

            // Download file
            const fileName = `Template_${profile.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(wb, fileName);

            alert(`ƒê√£ t·∫°o template th√†nh c√¥ng!\nFile: ${fileName}\n\nS·ªë sinh vi√™n: ${students.length}\nS·ªë c·ªôt ƒëi·ªÉm: ${weightColumns.length}`);
        }

        // Qu·∫£n l√Ω l·ªõp h·ªçc
        function initClasses() {
            const saved = localStorage.getItem('classes');
            if (saved) {
                classes = JSON.parse(saved);
            }
            updateClassSelect();
        }

        function saveClasses() {
            localStorage.setItem('classes', JSON.stringify(classes));
        }

        function updateClassSelect() {
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';

            for (const [key, classData] of Object.entries(classes)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = classData.name;
                if (key === currentClass) {
                    option.selected = true;
                }
                select.appendChild(option);
            }

            updateGenerateButtonState();
        }

        function loadClass() {
            const select = document.getElementById('classSelect');
            currentClass = select.value;

            if (currentClass && classes[currentClass]) {
                const classData = classes[currentClass];
                classListData = classData.students || [];

                document.getElementById('classInfo').style.display = 'block';
                document.getElementById('classDetails').textContent =
                    `${classData.name} - ${classData.description || ''} (${classListData.length} sinh vi√™n)`;
            } else {
                classListData = [];
                document.getElementById('classInfo').style.display = 'none';
            }

            updateGenerateButtonState();
        }

        function createNewClass() {
            const name = prompt('Nh·∫≠p t√™n l·ªõp (VD: SE1801):');
            if (!name) return;

            const id = 'class_' + Date.now();
            classes[id] = {
                name: name,
                description: '',
                students: []
            };

            currentClass = id;
            saveClasses();
            updateClassSelect();
            editClass();
        }

        function editClass() {
            if (!currentClass) {
                alert('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!');
                return;
            }

            const classData = classes[currentClass];
            document.getElementById('className').value = classData.name;
            document.getElementById('classDescription').value = classData.description || '';

            renderStudentEditor(classData.students || []);
            document.getElementById('classModal').classList.add('show');
        }

        function closeClassEditor() {
            document.getElementById('classModal').classList.remove('show');
        }

        function renderStudentEditor(students) {
            const editor = document.getElementById('studentEditor');
            editor.innerHTML = '';

            students.forEach(student => {
                addStudentRowWithData(student.mssv, student.name);
            });

            updateStudentCount();
        }

        function addStudentRow() {
            addStudentRowWithData('', '');
        }

        function addStudentRowWithData(mssv, name) {
            const editor = document.getElementById('studentEditor');
            const row = document.createElement('div');
            row.className = 'weight-row';
            row.innerHTML = `
                <input type="text" placeholder="MSSV" value="${mssv}" class="student-mssv">
                <input type="text" placeholder="H·ªç v√† t√™n" value="${name}" class="student-name">
                <button onclick="removeStudentRow(this)">X√≥a</button>
            `;
            editor.appendChild(row);
            updateStudentCount();
        }

        function removeStudentRow(btn) {
            btn.parentElement.remove();
            updateStudentCount();
        }

        function updateStudentCount() {
            const rows = document.querySelectorAll('#studentEditor .weight-row');
            document.getElementById('totalStudents').textContent = rows.length;
        }

        function handleClassStudentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                parseStudentList(jsonData);
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function parseStudentList(data) {
            if (data.length < 2) {
                alert('File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!');
                return;
            }

            const headers = data[0];
            const mssvIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('mssv') || normalized.includes('masinhvien') ||
                       normalized.includes('masv') || normalized === 'ma';
            });

            const nameIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('ten') || normalized.includes('hova') ||
                       normalized.includes('hovaten') || normalized.includes('ho');
            });

            if (mssvIndex === -1 || nameIndex === -1) {
                alert('Kh√¥ng t√¨m th·∫•y c·ªôt MSSV ho·∫∑c H·ªç t√™n!');
                return;
            }

            // Clear existing students
            document.getElementById('studentEditor').innerHTML = '';

            // Add students from file
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const mssv = row[mssvIndex] || '';
                const name = row[nameIndex] || '';

                if (mssv) {
                    addStudentRowWithData(mssv, name);
                }
            }

            alert(`ƒê√£ t·∫£i ${document.querySelectorAll('#studentEditor .weight-row').length} sinh vi√™n!`);
        }

        function saveClass() {
            if (!currentClass) return;

            const name = document.getElementById('className').value.trim();
            const description = document.getElementById('classDescription').value.trim();

            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n l·ªõp!');
                return;
            }

            const rows = document.querySelectorAll('#studentEditor .weight-row');
            const students = [];
            rows.forEach(row => {
                const mssv = row.querySelector('.student-mssv').value.trim();
                const studentName = row.querySelector('.student-name').value.trim();
                if (mssv && studentName) {
                    students.push({ mssv, name: studentName });
                }
            });

            classes[currentClass] = {
                name: name,
                description: description,
                students: students
            };

            saveClasses();
            updateClassSelect();
            loadClass();
            closeClassEditor();
            alert(`ƒê√£ l∆∞u l·ªõp "${name}" v·ªõi ${students.length} sinh vi√™n!`);
        }

        function deleteClass() {
            if (!currentClass) {
                alert('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!');
                return;
            }

            const classData = classes[currentClass];
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp "${classData.name}"?`)) {
                delete classes[currentClass];
                currentClass = '';
                classListData = [];
                saveClasses();
                updateClassSelect();
                document.getElementById('classInfo').style.display = 'none';
            }
        }

        function updateTemplateSource() {
            const source = document.querySelector('input[name="templateSource"]:checked').value;

            if (source === 'class') {
                document.getElementById('classSourceSection').style.display = 'block';
                document.getElementById('uploadSourceSection').style.display = 'none';
            } else {
                document.getElementById('classSourceSection').style.display = 'none';
                document.getElementById('uploadSourceSection').style.display = 'block';
            }

            updateGenerateButtonState();
        }

        function updateGenerateButtonState() {
            const source = document.querySelector('input[name="templateSource"]:checked').value;
            const btn = document.getElementById('generateTemplateBtn');

            if (source === 'class') {
                // T·ª´ l·ªõp ƒë√£ l∆∞u
                btn.disabled = !currentClass || !classes[currentClass] ||
                               !classes[currentClass].students ||
                               classes[currentClass].students.length === 0;
            } else {
                // Upload file
                btn.disabled = classListData.length === 0;
            }
        }

        // Kh·ªüi t·∫°o khi load trang
        window.addEventListener('DOMContentLoaded', () => {
            initDefaultProfiles();
            initClasses();
        });

        // H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát
        function removeVietnameseTones(str) {
            if (!str) return '';
            str = str.toString();
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, 'a');
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, 'e');
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, 'i');
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, 'o');
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, 'u');
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, 'y');
            str = str.replace(/ƒë/g, 'd');
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, 'A');
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, 'E');
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, 'I');
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, 'O');
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, 'U');
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, 'Y');
            str = str.replace(/ƒê/g, 'D');
            return str;
        }

        // H√†m chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh
        function normalizeString(str) {
            if (!str) return '';
            str = removeVietnameseTones(str);
            return str.toString()
                .toLowerCase()
                .replace(/\s+/g, '') // B·ªè t·∫•t c·∫£ kho·∫£ng tr·∫Øng
                .replace(/[()%]/g, '') // B·ªè d·∫•u ngo·∫∑c v√† %
                .trim();
        }

        // H√†m t√¨m ki·∫øm c·ªôt ƒëi·ªÉm d·ª±a tr√™n header
        function findScoreColumn(headerStr) {
            const normalized = normalizeString(headerStr);

            // Ki·ªÉm tra Lab (Lab1, Lab 1, Lab1(3.5%), etc.)
            for (let i = 1; i <= 8; i++) {
                const patterns = [
                    `lab${i}`,
                    `lab${i}3.5`,
                    `lab${i}35`
                ];
                if (patterns.some(p => normalized.includes(p))) {
                    return { key: `Lab ${i}`, weight: 3.5 };
                }
            }

            // Ki·ªÉm tra Quiz (Quiz1, Quiz 1, Quiz1(1.5%), etc.)
            for (let i = 1; i <= 8; i++) {
                const patterns = [
                    `quiz${i}`,
                    `quiz${i}1.5`,
                    `quiz${i}15`
                ];
                if (patterns.some(p => normalized.includes(p))) {
                    return { key: `Quiz ${i}`, weight: 1.5 };
                }
            }

            // Ki·ªÉm tra GD/Assignment (GD1, Gƒê1, Assignment GD1, ƒê√°nh gi√° Assignment Gƒê 1, etc.)
            for (let i = 1; i <= 2; i++) {
                const patterns = [
                    `gd${i}`,
                    `assignment`,
                    `danhgia`
                ];
                // N·∫øu ch·ª©a 'assignment' ho·∫∑c 'danhgia' v√† s·ªë i
                if (normalized.includes(String(i)) &&
                    (patterns.some(p => normalized.includes(p)))) {
                    return { key: `GD ${i}`, weight: 10 };
                }
                // Ho·∫∑c ch·ªâ ƒë∆°n gi·∫£n l√† gd1, gd2
                if (normalized === `gd${i}`) {
                    return { key: `GD ${i}`, weight: 10 };
                }
            }

            return null;
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `üìÑ ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            if (data.length < 2) {
                alert('File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!');
                return;
            }

            const headers = data[0];
            const results = [];
            let passedCount = 0;
            let failedCount = 0;
            matchedColumns = {};

            // T√¨m index c·ªßa c√°c c·ªôt
            const mssvIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('mssv') ||
                       normalized.includes('masinhvien') ||
                       normalized.includes('masv') ||
                       normalized === 'masinhvien' ||
                       normalized === 'ma';
            });

            const nameIndex = headers.findIndex(h => {
                if (!h) return false;
                const normalized = normalizeString(h);
                return normalized.includes('ten') ||
                       normalized.includes('hova') ||
                       normalized.includes('hovaten') ||
                       normalized.includes('ho') ||
                       normalized === 'ten' ||
                       normalized === 'hovaten';
            });

            if (mssvIndex === -1 || nameIndex === -1) {
                // Hi·ªÉn th·ªã headers ƒë·ªÉ debug
                const headerList = headers.filter(h => h).map((h, i) => `${i}: "${h}"`).join('\n');
                alert(`Kh√¥ng t√¨m th·∫•y c·ªôt MSSV ho·∫∑c H·ªç t√™n!\n\nC√°c c·ªôt t√¨m th·∫•y trong file:\n${headerList}\n\nVui l√≤ng ƒë·∫£m b·∫£o file c√≥:\n- C·ªôt ch·ª©a "MSSV" ho·∫∑c "M√£ sinh vi√™n"\n- C·ªôt ch·ª©a "H·ªç v√† t√™n" ho·∫∑c "T√™n"`);
                return;
            }

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const mssv = row[mssvIndex] || '';
                const name = row[nameIndex] || '';

                if (!mssv) continue;

                let totalScore = 0;
                let scoreDetails = {};

                // T√≠nh ƒëi·ªÉm theo tr·ªçng s·ªë
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    if (!header) continue;

                    const scoreColumn = findScoreColumn(header);
                    if (scoreColumn) {
                        const score = parseFloat(row[j]) || 0;
                        // C√¥ng th·ª©c: (ƒêi·ªÉm/100) √ó H·ªá s·ªë
                        const scoreRatio = score / 100; // Chuy·ªÉn v·ªÅ thang 0-1
                        const weightedScore = scoreRatio * scoreColumn.weight;
                        totalScore += weightedScore;
                        scoreDetails[scoreColumn.key] = score;

                        // L∆∞u mapping ƒë·ªÉ hi·ªÉn th·ªã
                        if (!matchedColumns[scoreColumn.key]) {
                            matchedColumns[scoreColumn.key] = header.toString();
                        }
                    }
                }

                // T√≠nh ƒëi·ªÉm qua m√¥n theo ng∆∞·ª°ng c·ªßa profile
                const passed = totalScore >= passThreshold;
                if (passed) passedCount++;
                else failedCount++;

                results.push({
                    mssv,
                    name,
                    totalScore: totalScore.toFixed(2),
                    passed,
                    scoreDetails
                });
            }

            processedData = results;
            displayResults(results, passedCount, failedCount);
            displayMatchedColumns();
        }

        function displayResults(results, passedCount, failedCount) {
            const totalCount = results.length;
            const passRate = totalCount > 0 ? ((passedCount / totalCount) * 100).toFixed(1) : 0;

            // C·∫≠p nh·∫≠t th·ªëng k√™
            document.getElementById('totalStudents').textContent = totalCount;
            document.getElementById('passedStudents').textContent = passedCount;
            document.getElementById('failedStudents').textContent = failedCount;
            document.getElementById('passRate').textContent = passRate + '%';

            // Hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            results.forEach((student, index) => {
                const tr = document.createElement('tr');
                tr.className = student.passed ? 'pass' : 'fail';

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.mssv}</td>
                    <td>${student.name}</td>
                    <td><strong>${student.totalScore}</strong></td>
                    <td>
                        <span class="status-badge ${student.passed ? 'badge-pass' : 'badge-fail'}">
                            ${student.passed ? '‚úì ƒê·∫°t' : '‚úó Ch∆∞a ƒë·∫°t'}
                        </span>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function displayMatchedColumns() {
            const weightsGrid = document.querySelector('.weights-grid');
            weightsGrid.innerHTML = '';

            // Hi·ªÉn th·ªã c√°c c·ªôt ƒë√£ kh·ªõp
            const allColumns = Object.keys(weights).sort((a, b) => {
                // S·∫Øp x·∫øp: Lab tr∆∞·ªõc, Quiz sau, GD cu·ªëi
                const getOrder = (key) => {
                    if (key.includes('Lab')) return 1;
                    if (key.includes('Quiz')) return 2;
                    if (key.includes('GD')) return 3;
                    return 4;
                };
                const orderDiff = getOrder(a) - getOrder(b);
                if (orderDiff !== 0) return orderDiff;
                // S·∫Øp x·∫øp theo s·ªë
                const numA = parseInt(a.match(/\d+/)?.[0] || 0);
                const numB = parseInt(b.match(/\d+/)?.[0] || 0);
                return numA - numB;
            });

            let totalMatched = 0;
            allColumns.forEach(key => {
                const div = document.createElement('div');
                div.className = 'weight-item';
                const matched = matchedColumns[key];
                if (matched) {
                    div.innerHTML = `<strong>${key}:</strong> ${weights[key]}% <span style="color: green;">‚úì (${matched})</span>`;
                    div.style.background = '#d4edda';
                    totalMatched++;
                } else {
                    div.innerHTML = `<strong>${key}:</strong> ${weights[key]}% <span style="color: red;">‚úó Kh√¥ng t√¨m th·∫•y</span>`;
                    div.style.background = '#f8d7da';
                }
                weightsGrid.appendChild(div);
            });

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            const weightsTitle = document.querySelector('.weights-info h3');
            const totalWeight = Object.values(matchedColumns).length > 0
                ? Object.keys(matchedColumns).reduce((sum, key) => sum + weights[key], 0)
                : 0;
            weightsTitle.innerHTML = `üìä Th√¥ng tin tr·ªçng s·ªë ƒëi·ªÉm (ƒê√£ kh·ªõp: ${totalMatched}/${allColumns.length} c·ªôt - ${totalWeight.toFixed(1)}%)`;
        }

        function exportResults() {
            if (processedData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            const exportData = processedData.map((student, index) => ({
                'STT': index + 1,
                'MSSV': student.mssv,
                'H·ªç v√† t√™n': student.name,
                'ƒêi·ªÉm t·ªïng': student.totalScore,
                'Tr·∫°ng th√°i': student.passed ? 'ƒê·∫°t' : 'Ch∆∞a ƒë·∫°t'
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£');

            XLSX.writeFile(wb, `Ket_qua_hoc_tap_${new Date().getTime()}.xlsx`);
        }
    </script>
</body>
</html>